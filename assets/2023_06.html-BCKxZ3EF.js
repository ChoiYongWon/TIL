import{_ as s,e as i,g as e,o as n}from"./app-dbWqT-s3.js";const t={};function o(h,a){return n(),i("div",null,a[0]||(a[0]=[e(`<h1 id="_2023-06" tabindex="-1"><a class="header-anchor" href="#_2023-06"><span>2023. 06.</span></a></h1><h2 id="_06-06" tabindex="-1"><a class="header-anchor" href="#_06-06"><span>06. 06.</span></a></h2><h3 id="redirect시-query-parameter가-사라지는-문제" tabindex="-1"><a class="header-anchor" href="#redirect시-query-parameter가-사라지는-문제"><span>redirect시 query parameter가 사라지는 문제</span></a></h3><h4 id="시나리오" tabindex="-1"><a class="header-anchor" href="#시나리오"><span>시나리오</span></a></h4><p>프론트는 React를 사용했고 AWS Amplify에 배포했고<br> 백엔드는 NestJs를 사용했고 AWS ECS를 통해 배포했다.</p><p>프론트에서 카카오 로그인을 위해 /auth/kakao로 백엔드에 접속하고, 로그인을 위해 다음과 같은 과정을 거친다.</p><ol><li>카카오 로그인 페이지로 Redirect 시킨다.</li><li>로그인 완료 후 카카오는 Redirect URL(<code>backend.com/auth/kakao/redirect</code>)로 사용자를 Redirect 시킨다.</li><li>백엔드는 카카오로부터 받아온 유저정보를 조회해서 새로운 토큰을 만들고, 프론트에 전달하기 위해 프론트 서버 URL 뒤에다가 Query parameter로 토큰값을 붙여서 Redirect 시켜준다. <blockquote><p>ex) <a href="http://front.com/auth/kakao/redirect?access_token=" target="_blank" rel="noopener noreferrer">front.com/auth/kakao/redirect?access_token=</a>&lt;토큰값&gt;</p></blockquote></li><li>프론트는 해당 값을 파싱하여 LocalStorage에 저장한다.</li></ol><h4 id="문제점" tabindex="-1"><a class="header-anchor" href="#문제점"><span>문제점</span></a></h4><p>시나리오 3번 과정에서 백엔드에서 프론트로 토큰값을 붙여서 Redirect 시켜주는 과정에서 프론트에서 Query parameter가 없어지는 문제가 발생하였다.</p><img alt="image" src="https://github.com/ChoiYongWon/TIL/assets/40623433/43ce1052-b35b-476e-8c92-5f66be2507ce"><p>마지막에서 두번째 줄에서 성공적으로 access_token이 들어오나 밑에서 다시 Query parameter가 없어진 상태로 리디렉션이 일어나는걸 볼 수 있다.</p><h4 id="삽질" tabindex="-1"><a class="header-anchor" href="#삽질"><span>삽질</span></a></h4><p>원인 파악을 위해 크롬 개발자 도구에서 네트워크 탭을 통해 거쳐온 URL들을 알아볼 수 있었다.<br> 실제로 토큰값을 포함한채로 Redirect <code>front.com/auth/kakao/redirect?access_token=&lt;토큰값&gt;</code> 되는데 다음 과정에서 <code>front.com/auth/kakao/redirect</code> 로 토큰값이 사라진채로 Redirect 되는걸 볼 수 있었고 또한, 로컬에선 잘 돌아가다가 배포 환경에서만 Query parameter가 사라졌다. 다음과 같이 원인이 될만한 요소를 나열해 보았다.</p><h5 id="_1-react-문제인가" tabindex="-1"><a class="header-anchor" href="#_1-react-문제인가"><span>1. React 문제인가?</span></a></h5><p>처음엔 React 문제인가 싶어서 자료를 찾아봤는데 해당 이슈가 발생한 사람이 별로 없었다.<br> React에서 문제가 발생 해봤자 사용하고 있는 react-router-dom 라이브러리에서 발생하겠다 싶어 해당 라이브러리를 비활성화 시키고 배포해보았다. 직접 <code>front.com/auth/kakao/redirect?access_token=&lt;토큰값&gt;</code>에 접속해봤을때 토큰값이 사라진걸 보아 React 문제는 아니란게 확신이 들었다.</p><h5 id="_2-amplify-문제인가" tabindex="-1"><a class="header-anchor" href="#_2-amplify-문제인가"><span>2. Amplify 문제인가?</span></a></h5><p>가장 의심스러웠지만 가장 아니였으면 하는 문제였다. 로컬 환경과 배포 환경에서의 다른점은 Amplify 밖에 없었기 때문에 가장 의심스러웠다. 자료를 찾아보니 나와 정확히 일치하는 이슈를 찾아볼 수 있었다.<br><a href="https://github.com/aws-amplify/amplify-hosting/issues/97" target="_blank" rel="noopener noreferrer">Pass url params in rewrites and redirects #97</a><br> 해당 글은 aws amplify에서 자체적으로 query를 날려버린다는 이슈였다.</p><p>amplify에서는 아래와 같이 redirect 정책을 설정할 수 있다.</p><img alt="image" src="https://github.com/ChoiYongWon/TIL/assets/40623433/36a8eddc-32e2-4a1d-b3f0-59441ad524c1"><p>여기서 query parameter를 전달할 수 있도록 설정할 수 있을것 같애서 공식 문서를 읽어보니</p><img alt="image" src="https://github.com/ChoiYongWon/TIL/assets/40623433/6232da46-39f7-4750-846a-a08d62fad487"><p>Amplify는 다음과 같은 예외 사항을 제외하고는 Query parameter를 모두 포워딩 해준다.</p><ul><li>기존 주소에서 query string이 특정 값으로 지정될 때, amplify는 특정 query parameter만 포워딩 한다.</li><li>소스 주소가 일치하는 대상 주소에 query parameter가 포함될 때, 즉 사용자가 명시적으로 query string을 작성했을 때 query parameter는 포워딩 되지 않는다.</li></ul><h4 id="해결-방법" tabindex="-1"><a class="header-anchor" href="#해결-방법"><span>해결 방법</span></a></h4><p>기존 Amplify 다시 쓰기 및 리디렉션 설정은 다음과 같이 되어있었다.</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">[</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">  {</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">    &quot;source&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;https://wooyeons.site&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">    &quot;target&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;https://www.wooyeons.site&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">    &quot;status&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;302&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">    &quot;condition&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">null</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">  },</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">  {</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">    &quot;source&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;/&lt;*&gt;&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">    &quot;target&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;/index.html&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">    &quot;status&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;404-200&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">    &quot;condition&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">null</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>다시 문제점 섹션에 네트워크 추적 사진을 보니<br> wooyeons.site에서 www.wooyeons.site로 포워딩 된다는 사실을 알 수 있었다.<br> 근데 Amplify Query 정책을 보았을 때 포워딩이 되어야하는거 아닌가?? 라는 의문점이 생겼다.</p><p>공식 문서를 좀 더 읽어보니 SPA용 Redirect 설정 값을 찾을 수 있었다.</p><img alt="image" src="https://github.com/ChoiYongWon/TIL/assets/40623433/34f7e5c6-77af-454f-8161-3ecc32b28a47"><p>다음과 같이 Redirect 설정을 해주니 해결되었다.</p><div class="language-json" data-highlighter="shiki" data-ext="json" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">[</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">  {</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">    &quot;source&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;&lt;/^[^.]+$|</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">\\\\</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">.(?!(css|gif|ico|jpg|js|png|txt|svg|woff|ttf|map|json)$)([^.]+$)/&gt;&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">    &quot;target&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;/index.html&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">    &quot;status&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;200&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">    &quot;condition&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">null</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">]</span></span></code></pre></div><h2 id="_06-10" tabindex="-1"><a class="header-anchor" href="#_06-10"><span>06. 10.</span></a></h2><h3 id="dns-record-a-vs-cname" tabindex="-1"><a class="header-anchor" href="#dns-record-a-vs-cname"><span>DNS Record A vs CNAME</span></a></h3><h4 id="a-record" tabindex="-1"><a class="header-anchor" href="#a-record"><span>A Record</span></a></h4><p><code>Record A</code>란 주소 <code>til.rtolzo.dev</code>에 대해서 <code>IP</code>로 매핑하겠다는 뜻이다.<br> 즉, url 창에 <code>til.rtolzo.dev</code>으로 접속하면 DNS 서버로부터 <code>til.crtolzo.dev</code>에 매핑된 <code>IP</code>를 제공받는다.</p><h5 id="a-record-활용" tabindex="-1"><a class="header-anchor" href="#a-record-활용"><span>A Record 활용</span></a></h5><p>개인 서버나, 호스팅은 대체로 IP 주소만 제공되므로,<br> 만약 web server나 application server를 서비스할때,<br> 유저들이 접속하기 편하게 A Record를 통해 해당 <code>Domain을 개인서버 IP에 매핑</code>할 수 있다.</p><h4 id="cname-record" tabindex="-1"><a class="header-anchor" href="#cname-record"><span>CNAME Record</span></a></h4><p><code>Record CNAME</code>이란 주소 <code>til.rtolzo.dev</code>에 대해서 다른 <code>Domain</code>으로 매핑하겠다는 뜻이다.<br> 즉, url 창에 <code>til.rtolzo.dev</code>으로 접속하면 DNS 서버로부터 <code>til.rtolzo.dev</code>에 매핑된 <code>Domain</code>를 제공받는다.</p><h5 id="cname-record-활용" tabindex="-1"><a class="header-anchor" href="#cname-record-활용"><span>CNAME Record 활용</span></a></h5><p>블로그와 같이 이미 Domain이 존재하는 서비스의 <code>주 Domain을 바꾸고 싶을때</code> 활용된다.<br> 예를 들어, <code>choiyongwon.github.io</code>를 <code>til.rtolzo.dev</code>로 바꾸고 싶을때 활용할 수 있다.</p><h2 id="_06-14" tabindex="-1"><a class="header-anchor" href="#_06-14"><span>06. 14.</span></a></h2><h3 id="dns-cname-record-흐름" tabindex="-1"><a class="header-anchor" href="#dns-cname-record-흐름"><span>DNS CNAME Record 흐름</span></a></h3><h4 id="cname-시나리오" tabindex="-1"><a class="header-anchor" href="#cname-시나리오"><span>CNAME 시나리오</span></a></h4><p>유저 A는 자신의 블로그 <code>choiyongwon.github.io</code>의 주소가 마음에 안들어서<br> 도메인 <code>til.rtolzo.dev</code>를 구입하여 연결시키려 한다.</p><p>DNS 공급자(ex: 가비아)를 통해 <code>til.rtolzo.dev</code> CNAME에 <code>choiyongwon.github.io</code>을 등록하였다.</p><p>추가로, <code>github</code> 사이트에서 Custom Domain으로 <code>til.rtolzo.dev</code>을 등록하였다.<br> 이는 주 Domain을 바꾸기 위한 과정이다.<br> 즉, 기존 <code>choiyongwon.github.io</code>으로 접속하면 <code>til.rtolzo.dev</code>으로 리다렉트된다.</p><h4 id="cname-실제-동작-과정" tabindex="-1"><a class="header-anchor" href="#cname-실제-동작-과정"><span>CNAME 실제 동작 과정</span></a></h4><h5 id="case-1-til-rtolzo-dev으로-접속할-경우" tabindex="-1"><a class="header-anchor" href="#case-1-til-rtolzo-dev으로-접속할-경우"><span>Case 1 (<code>til.rtolzo.dev</code>으로 접속할 경우)</span></a></h5><ol><li><code>til.rtolzo.dev</code>으로 접속한다.</li><li>DNS Server로부터 CNAME 레코드로 등록된 <code>choiyongwon.github.io</code>을 받아온다.</li><li><code>choiyongwon.github.io</code>으로 접속한다.</li><li>DNS Server로부터 A 레코드로 등록된 <code>choiyongwon.github.io</code>의 <code>IP</code>를 받아온다.</li><li><code>IP</code>로 접속한다.</li><li>github 서버에서 source URL이 <code>til.rtolzo.dev</code>임을 확인하고 매핑된 github page로 연결해준다.</li></ol><h5 id="case-2-choiyongwon-github-io로-접속할-경우" tabindex="-1"><a class="header-anchor" href="#case-2-choiyongwon-github-io로-접속할-경우"><span>Case 2 (<code>choiyongwon.github.io</code>로 접속할 경우)</span></a></h5><ol><li><code>choiyongwon.github.io</code>으로 접속한다.</li><li>DNS Server로부터 A 레코드로 등록된 <code>choiyongwon.github.io</code>의 <code>IP</code>를 받아온다.</li><li><code>IP</code>로 접속한다.</li><li>github 서버에서 source URL이 <code>choiyongwon.github.io</code>임을 확인하고 아래 결과값과 같이 301 응답코드를 반환하고 바뀐 등록된 주 도메인(<code>til.rtolzo.dev</code>)으로 리디렉트 시킨다.</li></ol><div class="language-http" data-highlighter="shiki" data-ext="http" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">GET</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> /TIL HTTP/2</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">Host</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> choiyongwon.github.io</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">user-agent</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> insomnia/2022.7.0</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">accept</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> */*</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">HTTP/2 </span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">301</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">location</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> https://til.rtolzo.dev</span></span></code></pre></div><ol start="5"><li>goto Case 1</li></ol>`,54)]))}const r=s(t,[["render",o],["__file","2023_06.html.vue"]]),d=JSON.parse(`{"path":"/archives/2023_06.html","title":"2023. 06.","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"06. 06.","slug":"_06-06","link":"#_06-06","children":[{"level":3,"title":"redirect시 query parameter가 사라지는 문제","slug":"redirect시-query-parameter가-사라지는-문제","link":"#redirect시-query-parameter가-사라지는-문제","children":[]}]},{"level":2,"title":"06. 10.","slug":"_06-10","link":"#_06-10","children":[{"level":3,"title":"DNS Record A vs CNAME","slug":"dns-record-a-vs-cname","link":"#dns-record-a-vs-cname","children":[]}]},{"level":2,"title":"06. 14.","slug":"_06-14","link":"#_06-14","children":[{"level":3,"title":"DNS CNAME Record 흐름","slug":"dns-cname-record-흐름","link":"#dns-cname-record-흐름","children":[]}]}],"git":{"updatedTime":1741537872000,"contributors":[{"name":"ChoiYongWon","username":"ChoiYongWon","email":"yongwon0824@naver.com","commits":9,"url":"https://github.com/ChoiYongWon"}],"changelog":[{"hash":"f6b57824696f693a7872ac6a4b760fdcb840cf71","date":1741537872000,"email":"yongwon0824@naver.com","author":"ChoiYongWon","message":"feat: 기존 글 archive로 이동 및 mermaid 추가"},{"hash":"ac95446983320fd6d0548bee600a518d79ece54a","date":1711395328000,"email":"yongwon0824@naver.com","author":"ChoiYongWon","message":"3/25 Root 컴포넌트에서 'use client'를 사용했을 때"},{"hash":"d2e897019cff681ce39113d46373ed7dc0edc008","date":1711229179000,"email":"yongwon0824@naver.com","author":"ChoiYongWon","message":"CNAME 수정"},{"hash":"5e51976809627cbe004fe8ac7e04f09b53337ccb","date":1711225054000,"email":"yongwon0824@naver.com","author":"ChoiYongWon","message":"INIT"},{"hash":"4f1aa0c3cfea0df3ef7fa3116bbc3979d8da6f5e","date":1686100122000,"email":"yongwon0824@naver.com","author":"ChoiYongWon","message":"date 추가"},{"hash":"bf37369d8d988a866482fe82e71afc3eaf969aee","date":1685962795000,"email":"yongwon0824@naver.com","author":"ChoiYongWon","message":"제목 변경 2"},{"hash":"38dcfc7c19383a981b0962ef52a2727e1097b9b6","date":1685962704000,"email":"yongwon0824@naver.com","author":"ChoiYongWon","message":"제목 변경"},{"hash":"2bcce406678c27a6354f2de0f03f902eb82c4c18","date":1685959747000,"email":"yongwon0824@naver.com","author":"ChoiYongWon","message":"구조 변경"},{"hash":"acdf5e971b4b01729ea6be0dfe06d719d8c4b1a6","date":1685958486000,"email":"yongwon0824@naver.com","author":"ChoiYongWon","message":"블로그 리뉴얼"}]},"filePathRelative":"archives/2023_06.md"}`);export{r as comp,d as data};
