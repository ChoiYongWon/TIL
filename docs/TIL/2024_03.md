# 2024. 03.

## 03. 19.

### next-auth ì¸ì¦/ì¸ê°€ ê³ ë¯¼

ë¡œê·¸ì¸ ê³¼ì •ì—ì„œ (next-auth ì‚¬ìš©)  
next-authì—ì„œ ì œê³µí•˜ëŠ” `session-token` ë§Œìœ¼ë¡œ ì¸ì¦/ì¸ê°€ë¥¼ ë‹´ë‹¹í•´ë„ ë ê¹Œ??  
JWTë¥¼ ì•ˆì¨ë„ ë ê¹Œ?? ë¼ëŠ” ê³ ë¯¼ì¤‘

[next-authë¥¼ í™œìš©í•œ ì¸ì¦ ë° ì¸ê°€ ì´í•´í•˜ê¸°](https://geuni620.github.io/blog/2024/1/17/authorization/)
[next-auth credential providerì—ì„œ jwt ì‚¬ìš©í•˜ê¸° (í•´ì™¸)](https://remaster.com/blog/next-auth-jwt-session)
[next-authì—ì„œ ì„¸ì…˜ ë° JWTì— ëŒ€í•œ ISSUE (í•´ì™¸)](https://github.com/nextauthjs/next-auth/discussions/2790)

í˜„ì¬ ê°œë°œí•˜ê³  ìˆëŠ” ì„œë¹„ìŠ¤ ìì²´ê°€ NextJS í’€ìŠ¤íƒìœ¼ë¡œ ê°œë°œì¤‘ì´ë‹¤.  
ì¦‰, route handlerì—ì„œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì— ëŒ€í•œ ì„¸ì…˜ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤. (ìš”ì²­í•œ ìœ ì €ì˜ ì‹ ì›ì„ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤.)

ë§Œì•½ API ì„œë²„ê°€ ë”°ë¡œ ìˆë‹¤ê³  í•˜ë©´ JWTê°€ í•„ìš”í•  ìˆ˜ ìˆê² ë‹¤.

[next-auth FAQ: next-authì—ì„œ ì œê³µí•˜ëŠ” JWT(session-token)ì˜ ì¥ì ì€ ë­”ê°€ìš”](https://next-auth.js.org/faq)

ìœ„ FAQì—,

`NextAuth.jsì˜ JSON ì›¹ í† í°ì€ ì•”í˜¸í™” ì•”í˜¸í™”(JWE)ë¥¼ ì‚¬ìš©í•˜ì—¬ í¬í•¨ëœ ì •ë³´ë¥¼ JWT ì„¸ì…˜ í† í°ì— ì§ì ‘ ì €ì¥í•˜ì—¬ ë³´ì•ˆì„ ìœ ì§€í•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ ì´ í† í°ì„ ì‚¬ìš©í•˜ì—¬ í¬í•¨ëœ ì •ë³´ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•  í•„ìš” ì—†ì´ ë™ì¼í•œ ë„ë©”ì¸ì˜ ì„œë¹„ìŠ¤ ë° API ê°„ì— ì •ë³´ë¥¼ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`

ë˜í•œ,

`JWTëŠ” ì„œë²„ ì½ê¸° ì „ìš© ì¿ í‚¤ì— ì €ì¥ë˜ë¯€ë¡œ ì‚¬ì´íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ íƒ€ì‚¬ JavaScriptê°€ JWTì˜ ë°ì´í„°ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì•”í˜¸í™” ì—†ì´ë„ í´ë¼ì´ì–¸íŠ¸ê°€ ì•Œì•„ë„ ìƒê´€ì—†ëŠ” ì •ë³´ë¥¼ ì•ˆì „í•˜ê²Œ ì €ì¥í•˜ëŠ” ë° JWTë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`

ë¬¸í•­ì„ ì½ì–´ë³´ì•˜ì„ ë•Œ, Session-tokenë§Œìœ¼ë¡œ ì¸ì¦/ì¸ê°€ë¥¼ ë‹´ë‹¹í•´ë„ ë ê²ƒê°™ì€ ëŠë‚Œì„ ë°›ì•˜ë‹¤.

ê·¸ëŸ¼ Session Expire ì‹œê°„ì„ ëŠ˜ë ¤ì•¼ë˜ë‚˜..??  
ì¼ë‹¨ Session Tokenë§Œ ì‚¬ìš©í•´ë³´ì.

## 03. 23.

### next-auth í´ë¼ì´ì–¸íŠ¸ ì„¸ì…˜ ìˆ˜ì • ê°€ëŠ¥

í´ë¼ì´ì–¸íŠ¸ì—ì„œ useSession, auth ì„¸ì…˜ ë°”ê¿€ ìˆ˜ìˆìŒ  
[next-auth ê³µì‹ ë¬¸ì„œ #updating-the-session](https://next-auth.js.org/getting-started/client#updating-the-session)

ì•¼ í˜¸

### prismaClientë¥¼ edge í™˜ê²½ì—ì„œ ì‹¤í–‰

middlewareì—ì„œ prismaClientë¥¼ ì‚¬ìš©í•  ì¼ì´ ìƒê²¼ë‹¤.  
[middlewareì€ vercel edge í™˜ê²½ì—ì„œ ì‹¤í–‰](https://vercel.com/docs/functions/edge-middleware)ë˜ëŠ”ë°, prismaClientë¥¼ edge í™˜ê²½ì—ì„œ ì‹¤í–‰í•˜ë ¤ë©´ Accelerateë¥¼ ì‚¬ìš©í•´ì•¼ëœë‹¤.

AccelerateëŠ” Edgeí™˜ê²½ì˜ DB ìºì‹±ì„œë¹„ìŠ¤. [ì°¸ê³ ](https://www.prisma.io/docs/accelerate/getting-started)  
Accelerate ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•˜ê³  ê¸°ì¡´ DB URLì„ ì—°ê²°í•˜ë©´ ë§¤í•‘ëœ ìƒˆë¡œìš´ URLì„ ë°˜í™˜í•´ì¤€ë‹¤.

í•´ë‹¹ URLì— ìš”ì²­í•˜ë©´ Accelerateì—ì„œ ê¸°ì¡´ ìš°ë¦¬ì˜ DBì— ìš”ì²­ì„ í•˜ê³  ê²°ê³¼ê°’ì„ ì‘ë‹µí•´ì¤€ë‹¤.  
í•´ë‹¹ ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì€ ìºì‹±ëœë‹¤.

ê¸°ì¡´ DBë„ ìºì‹±ê¸°ëŠ¥ì´ ìˆì„í…ë° Accelerateë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ”??  
ì•„ë§ˆ Edgeí™˜ê²½ì— ë°°í¬ë˜ì–´ìˆê¸°ì— ì‘ë‹µê³¼ ì²˜ë¦¬ì†ë„(Accelerate êµ¬ì¡°ìƒ)ê°€ ë¹¨ë¼ì„œ Edge í™˜ê²½ì—ì„œ ì“°ê¸° ì í•©í•˜ì§€ ì•Šì„ê¹Œ?  
ê¸°ì¡´ prismaClientì„ edgeí™˜ê²½(ë¦¬ì†ŒìŠ¤ê°€ ì œí•œëœ í™˜ê²½)ì—ì„œ ì‹¤í–‰ì‹œí‚¤ê¸°ì—ëŠ” ëŠë¦¬ê¸°ì— ë‚´ì¥ë˜ì–´ìˆëŠ” prisma/edgeì—ì„œ prismaClientë¥¼ ì‚¬ìš©í•´ì•¼í•œë‹¤.

## 03. 24.

### ServerComponentì— ëŒ€í•œ ê³ ì°° (ê³ ë¯¼ì¤‘)

NextJSì—ì„œ ì»´í¬ë„ŒíŠ¸ë“¤ì„ ì§ë ¬í™” í•  ë•Œ ClientComponentëŠ” ì§ë ¬í™”ê°€ ì•ˆë¨ìœ¼ë¡œ ìì²´ ì°¸ì¡°ê°’(./ClientComponent.js)ìœ¼ë¡œ ë³€í™˜ì‹œí‚¨ë‹¤.

íŠ¸ë¦¬ êµ¬ì¡°ë¡œ ì»´í¬ë„ŒíŠ¸ë“¤ì´ êµ¬ì„±ë˜ì–´ìˆëŠ”ë° ê°€ì¥ ìµœìƒë‹¨ì˜ ì»´í¬ë„ŒíŠ¸ê°€ ClientComponentë¡œ êµ¬ì„±ë˜ì–´ìˆìœ¼ë©´  
ìš°ë¦¬ê°€ ë¸Œë¼ìš°ì €ì— ì²˜ìŒ ì ‘ì†í–ˆì„ ë•Œ ìµœìƒë‹¨ ì»´í¬ë„ŒíŠ¸ì— ëŒ€í•œ ì°¸ì¡°ê°’ë§Œ ì „ë‹¬ë°›ëŠ”ê±° ì•„ë‹Œê°€??

ì—ì„œ ë‚˜ì˜¨ ì˜ë¬¸ì´ë‹¤.

ì§ì ‘ í…ŒìŠ¤íŠ¸ í•´ë³´ì•˜ì„ ë–„,

NextJSì—ì„œëŠ” ì§ë ¬í™” ë‹¨ê³„ì—ì„œ ClientComponentì˜ ì§ë ¬í™” ê°€ëŠ¥í•œ ë¶€ë¶„(ì˜ˆë¥¼ ë“¤ì–´, `ì‹œë§¨í‹± íƒœê·¸`, `í…ìŠ¤íŠ¸`, `ìŠ¤íƒ€ì¼`)ì€ ì§ë ¬í™” í•˜ê³  ë‚˜ë¨¸ì§€ `onClick í•¨ìˆ˜`ë“± ì§ë ¬í™” ë˜ì§€ ì•ŠëŠ” ë¶€ë¶„ì€ ì°¸ì¡°ê°’ìœ¼ë¡œ ë³€í™˜ì‹œì¼œ í´ë¼ì´ì–¸íŠ¸ ìª½ì—ì„œ Hydration í•˜ëŠ”ë“¯í•˜ë‹¤.

ì¢‹ì€ê¸€  
[Next) ì„œë²„ ì»´í¬ë„ŒíŠ¸(React Server Component)ì— ëŒ€í•œ ê³ ì°°](https://velog.io/@2ast/React-%EC%84%9C%EB%B2%84-%EC%BB%B4%ED%8F%AC%EB%84%8C%ED%8A%B8React-Server-Component%EC%97%90-%EB%8C%80%ED%95%9C-%EA%B3%A0%EC%B0%B0)

'use client' ì¦‰, ClientComponentê°€ ì½”ë“œìŠ¤í”Œë¦¬íŒ…ì˜ ë¶„ê¸°ì ì´ ëœë‹¤ê³  í•˜ëŠ”ë°..  
ServerComponentì™€ ClientComponent ë‘˜ë‹¤ ì„œë²„ì—ì„œ ë Œë”ë§ë˜ëŠ”ê±´ ë§ˆì°¬ê°€ì§„ë°, 'use client'ë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ ê°€ ë‹¨ìˆœ ì„œë²„ì—ì„œ ë Œë”ë§í•  ë•Œ `ì´ ì»´í¬ë„ŒíŠ¸ëŠ” Hydrationì´ í•„ìš”í•œ ì»´í¬ë„ŒíŠ¸ì•¼`ë¼ê³  ì•Œë ¤ì£¼ëŠ”ê²ƒ ë¹¼ê³ ëŠ” ë‹¤ë¥¸ ì—­í• ì´ ìˆëŠ”ì§€ ê¶ê¸ˆí•˜ë‹¤.  

## 03. 25.

### Root ì»´í¬ë„ŒíŠ¸ì—ì„œ 'use client'ë¥¼ ì‚¬ìš©í–ˆì„ ë•Œ

ì–´ì œ í–ˆë˜ ì‚½ì§ˆì— ì´ì–´ì„œ  

```ts
// app/layout.tsx
import { createContext } from "react";

//  createContext is not supported in Server Components
export const ThemeContext = createContext({});

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        <ThemeContext.Provider value="dark">{children}</ThemeContext.Provider>
      </body>
    </html>
  );
}
```

ThemeContextëŠ” ServerComponentì—ì„œ ì‚¬ìš©í•  ìˆ˜ ì—†ê¸°ì— ì•„ë˜ì™€ ê°™ì´ theme-providerë¼ëŠ” ClientComponentë¥¼ ë§Œë“¤ê³  children propsë¡œ ë„˜ê²¨ì¤€ë‹¤.  

```ts
// app/theme-provider.tsx
"use client";

import { createContext } from "react";

export const ThemeContext = createContext({});

export default function ThemeProvider({
  children,
}: {
  children: React.ReactNode;
}) {
  return <ThemeContext.Provider value="dark">{children}</ThemeContext.Provider>;
}
```

ë‹¤ì‹œ ëŒì•„ì™€ì„œ app/layout.tsxì—ì„œ ì•„ë˜ì™€ ê°™ì´ Rootë¥¼ ServerComponentë¡œ ìœ ì§€í•  ìˆ˜ ìˆë‹¤  

```ts
// app/layout.tsx
import ThemeProvider from "./theme-provider";

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html>
      <body>
        <ThemeProvider>{children}</ThemeProvider>
      </body>
    </html>
  );
}
```  

> You should render providers as deep as possible in the tree â€“ notice how ThemeProvider only wraps `{children}` instead of the entire `<html>` document. This makes it easier for Next.js to optimize the static parts of your Server Components.  

ì¶œì²˜ : [NextJS ê³µì‹ë¬¸ì„œ rendering/composition-patterns](https://nextjs.org/docs/app/building-your-application/rendering/composition-patterns#using-context-providers)  

ëŒ€ì¶© Providerë¥¼ ë”°ë¡œ Client Componentë¡œ ë§Œë“¤ì–´ì„œ {children} propsë¡œ ë„˜ê¸°ë©´ ê·¸ ë‚´ë¶€ì˜ ì»´í¬ë„ŒíŠ¸ëŠ” ServerComponentë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ëŠ” ë‚´ìš©ì´ë‹¤.  
ì´ë ‡ê²Œ í•˜ë©´ ì¶”ê°€ì ìœ¼ë¡œ Client Javascript Bundle Sizeë„ ì¤„ì¼ ìˆ˜ ìˆë‹¤ê³  í•œë‹¤.  


#### ì¶”ê°€ ì‚½ì§ˆ

> ì—¬ëŸ¬ê°œì˜ 'use client' ì§€ì‹œì–´ë¥¼ ì‚¬ìš©í•˜ë©´ ì—¬ëŸ¬ê°œì˜ client ë²ˆë“¤ë¡œ ë‚˜ë‰˜ì–´ì§„ë‹¤.  
> 'use client' ì§€ì‹œì–´ë¥¼ ì‚¬ìš©í•˜ë©´ í•´ë‹¹ ì»´í¬ë„ŒíŠ¸ë‚´ì— ìˆëŠ” ëª¨ë“  ëª¨ë“ˆê³¼(import) ChildComponentë“¤ì´ client ë²ˆë“¤ì— ì¶”ê°€ë˜ëŠ”ê±¸ë¡œ ê°„ì£¼ëœë‹¤.  

ì¶œì²˜ : [If I pass a server component to a client component via the children prop, will it be rendered on the client?](https://stackoverflow.com/questions/77015023/if-i-pass-a-server-component-to-a-client-component-via-the-children-prop-will-i)  


> ì„œë²„ ì»´í¬ë„ŒíŠ¸ëŠ” ë Œë”ë§ ê³¼ì •ì—ì„œ ì§ë ¬í™”ëœ ê²°ê³¼ê°€ inline scriptë¡œ ì‚½ì…ëœë‹¤ëŠ” ì •ë³´ë¥¼ ì–»ì„ ìˆ˜ ìˆì—ˆë‹¤.  

ì¶œì²˜ : [ìƒˆë¡œ ë“±ì¥í•œ React ServerComponent ì´í•´í•˜ê¸°](https://yozm.wishket.com/magazine/detail/2271/)


> ì„œë²„ ì»´í¬ë„ŒíŠ¸ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²½ìš°, í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì— propsë¡œ ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ê³  ì‹¶ì„ ìˆ˜ ìˆëŠ”ë°, ServerComponentì—ì„œ ClientComponentë¡œ ì „ë‹¬ë˜ëŠ” propsëŠ” Reactì—ì„œ ì§ë ¬í™”í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.  
> ì´ê±´ ë‚´ ìƒê° ğŸ‘‰ (ì„œë²„ ë Œë”ë§ì„ ìœ„í•´ì„œëŠ” ì§ë ¬í™”ë¥¼ í•´ì•¼ë˜ê¸° ë•Œë¬¸ì— ë§Œì•½ ServerComponentì—ì„œ ClientComponentë¡œ ì „ë‹¬ë˜ëŠ” propsê°€ ì§ë ¬í™”ê°€ ì•ˆë  ê²½ìš°ì—ëŠ” í•´ë‹¹ ServerComponentë„ ì§ë ¬í™”ê°€ ì•ˆë˜ê¸° ë•Œë¬¸ìœ¼ë¡œ ì˜ˆìƒ. ì§ë ¬í™”ê°€ ì•ˆë˜ë©´ ì•„ì˜ˆ js ë²ˆë“¤ë¡œ ë¹¼ê³  ì°¸ì¡°ê°’ë§Œ ë‚¨ê²¨ì•¼í•œë‹¤.)  

ì¶œì²˜ : [rocketengine í‹°ìŠ¤í† ë¦¬ Getting Started - React Essentials](<https://rocketengine.tistory.com/entry/NextJS-13-Getting-Started-React-Essentials#%EC%84%9C%EB%B2%84%EC%97%90%EC%84%9C%20%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8%20%EC%BB%B4%ED%8F%AC%EB%84%8C%ED%8A%B8%EB%A1%9C%20props%20%EC%A0%84%EB%8B%AC(serializable)-1>)

#### ì •ë¦¬

ìš°ë¦¬ê°€ ì‚¬ì´íŠ¸ì— ë°©ë¬¸í•˜ë©´ ì„œë²„ì™€ ë¸Œë¼ìš°ì €ì—ì„  ë‹¤ìŒê³¼ ê°™ì€ ê³¼ì •ì„ ê±°ì¹œë‹¤.  


1. [Server] RootComponentë¶€í„° ìˆœíšŒë¥¼ í•˜ë©´ì„œ ServerComponentë¥¼ ë‹¤ ë Œë”ë§í•˜ê³  ì§ë ¬í™” í•œë‹¤.  
2. [Server] ClientComponentëŠ” js ë²ˆë“¤ì— í¬í•¨ì‹œí‚¨ë‹¤.    
   `ì´ ë•Œ, use clientë¡œ ëª…ì‹œëœ ClientComponentë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„ ì–¸ëœ ëª¨ë“  importë‚˜ ChildComponentëŠ” js ë²ˆë“¤ì— í¬í•¨ëœë‹¤. childrenìœ¼ë¡œ ë„˜ê²¨ì§„ ë°ì´í„°ëŠ” ì‹¤ì œë¡œ ServerComponentì—ì„œ importëœ Componentì´ê¸° ë•Œë¬¸ì— ServerComponentë¡œ ê°„ì£¼ëœë‹¤.`
3. [Server] ServerComponentë¥¼ ì§ë ¬í™”í•œ ê²°ê³¼ë¥¼ inline scriptì— í¬í•¨ì‹œí‚¨ htmlì„ ë¸Œë¼ìš°ì €ì— ì‘ë‹µí•œë‹¤.  
4. [Browser] js ë²ˆë“¤ì„ ë‹¤ì‹œ ì„œë²„ì— ìš”ì²­í•˜ì—¬ ClientComponentë¥¼ Hydrateí•œë‹¤.  
5. [Browser] ì´ë¯¸ ë Œë”ë§ ëœ ServerComponentì— ëŒ€í•œ ë Œë”íŠ¸ë¦¬ ì •ë³´ëŠ” js ë²ˆë“¤ì— í¬í•¨ë˜ì–´ìˆì§€ ì•Šìœ¼ë¯€ë¡œ inline scriptì— í¬í•¨ë˜ì–´ìˆëŠ” ServerComponentë¥¼ ì§ë ¬í™”í•œ ê²°ê³¼ë¥¼ í•´ì„í•˜ì—¬ ê°€ìƒë”ì— í¬í•¨ì‹œí‚¨ë‹¤.  

#### ê²°ë¡ 

ê°€ì¥ ì¸ìƒê¹Šì—ˆê³  ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ëŠ” ë¶€ë¶„ì€  
- ServerComponentë¥¼ ì§ë ¬í™”í•œ ê²°ê³¼ë¥¼ ì²« htmlì— í¬í•¨ì‹œì¼œ ì¤€ë‹¤ëŠ”ê²ƒ.
- 'use client' ì§€ì‹œì–´ëŠ” íŒŒì¼ì´ë‚˜ ëª¨ë“ˆ ë ˆë²¨ì—ì„œ ì‘ë™í•œë‹¤ëŠ”ê²ƒ,  

  - ì¦‰, 'use client' ì§€ì‹œì–´ê°€ ì„ ì–¸ëœ ì»´í¬ë„ŒíŠ¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ëª¨ë“  importë‚˜ ChildComponentëŠ” ëª¨ë‘ ClientComponentì´ê³  client bundleì— í¬í•¨ëœë‹¤ëŠ”ê²ƒì´ë‹¤. í•˜ì§€ë§Œ props (íŠ¹íˆ children)ë¡œ ë„˜ê²¨ì§„ ë°ì´í„°ëŠ” Serverì—ì„œ ë Œë”ë§í•  ìˆ˜ ìˆë‹¤. (ServerComponentì—ì„œ children propsë¡œ ì „ë‹¬ëœ ì»´í¬ë„ŒíŠ¸ëŠ” ì„œë²„ì— ì˜í•´ ê³ ì •ëœ ì •ì ì¸ ë°ì´í„°ì´ê¸° ë•Œë¬¸.)  

ê°œì¸ì ìœ¼ë¡œ í˜ë“  ì‚½ì§ˆì´ì—ˆë‹¤.    
í•˜ì§€ë§Œ ì•„ì§ ì™„ë²½íˆ ì´í•´í•œ ëŠë‚Œì€ ì•„ë‹ˆë‹¤. ë‚˜ë¨¸ì§€ ê°œë…ì€ ì‚¬ìš©í•˜ë©´ì„œ ë°°ì›Œì•¼ê² ë‹¤.  

#### ì°¸ê³ í•˜ë©´ ì¢‹ì„ë“¯í•œ ì •ë³´

[NextJS App router ì‹œë®¬ ì‚¬ì´íŠ¸](https://nextjs-app-router-training.vercel.app/)  
[RSC Payloadì— ëŒ€í•´ì„œ (í•´ì™¸)](https://hrtyy.dev/web/rsc_payload/)  
[How React server components work: an in-depth guide](https://www.plasmic.app/blog/how-react-server-components-work)
